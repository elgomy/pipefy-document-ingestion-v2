#!/usr/bin/env python3
"""
Test completo para verificar guardado de cartÃ£o CNPJ
Verifica que se guarde tanto en bucket 'documents' como en tabla 'documents'
"""
import os
import asyncio
from datetime import datetime
from dotenv import load_dotenv
from src.services.cnpj_service import CNPJService
from supabase import create_client, Client

# Cargar variables de entorno
load_dotenv()

async def test_cartao_cnpj_completo():
    """
    Test completo del guardado de cartÃ£o CNPJ
    """
    
    print("ğŸ§ª TEST COMPLETO: CARTÃƒO CNPJ - BUCKET + TABLA DOCUMENTS\n")
    
    # ConfiguraciÃ³n del test
    TEST_CNPJ = "37335118000180"
    TEST_CASE_ID = f"TEST_CARTAO_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    print(f"ğŸ“‹ CONFIGURACIÃ“N DEL TEST:")
    print(f"   CNPJ: {TEST_CNPJ}")
    print(f"   Case ID: {TEST_CASE_ID}")
    
    # Verificar credenciales de Supabase
    supabase_url = os.getenv("SUPABASE_URL")
    supabase_key = os.getenv("SUPABASE_ANON_KEY")
    
    if not supabase_url or not supabase_key:
        print("âŒ Error: Credenciales de Supabase no configuradas")
        return
    
    print(f"\nğŸ” VERIFICANDO CREDENCIALES:")
    print(f"   Supabase URL: {'âœ… Configurado' if supabase_url else 'âŒ Faltante'}")
    print(f"   Supabase Key: {'âœ… Configurado' if supabase_key else 'âŒ Faltante'}")
    
    try:
        # Inicializar clientes
        supabase: Client = create_client(supabase_url, supabase_key)
        cnpj_service = CNPJService(supabase)
        
        print(f"\nğŸš€ PASO 1: Generando cartÃ£o CNPJ...")
        
        # Generar cartÃ£o CNPJ
        result = await cnpj_service.gerar_e_armazenar_cartao_cnpj(
            cnpj=TEST_CNPJ,
            case_id=TEST_CASE_ID,
            save_to_database=True
        )
        
        if result.get("success"):
            print(f"âœ… CartÃ£o gerado exitosamente:")
            print(f"   ğŸ“„ CNPJ: {result['cnpj']}")
            print(f"   ğŸ¢ RazÃ£o Social: {result['razao_social']}")
            print(f"   ğŸ“ Storage Path: {result['file_path']}")
            print(f"   ğŸ”— URL PÃºblica: {result['supabase_public_url']}")
            print(f"   ğŸ†” Document ID: {result.get('supabase_document_id', 'N/A')}")
            print(f"   ğŸ’¾ Guardado en tabla: {'âœ… SÃ­' if result.get('saved_to_database') else 'âŒ No'}")
            print(f"   ğŸ“Š Tamanho: {result.get('file_size_bytes', 0):,} bytes")
        else:
            print(f"âŒ Error generando cartÃ£o: {result.get('error', 'Error desconocido')}")
            return
        
        print(f"\nğŸ” PASO 2: Verificando bucket 'documents'...")
        
        # Verificar que existe en Storage
        try:
            storage_info = supabase.storage.from_("documents").list(TEST_CASE_ID)
            if storage_info:
                print(f"âœ… Archivo encontrado en bucket 'documents':")
                for file_info in storage_info:
                    print(f"   ğŸ“„ Nombre: {file_info['name']}")
                    print(f"   ğŸ“Š Tamanho: {file_info.get('metadata', {}).get('size', 'N/A')} bytes")
                    print(f"   ğŸ“… Creado: {file_info.get('created_at', 'N/A')}")
            else:
                print(f"âŒ Archivo NO encontrado en bucket 'documents'")
        except Exception as e:
            print(f"âŒ Error verificando bucket: {str(e)}")
        
        print(f"\nğŸ—„ï¸ PASO 3: Verificando tabla 'documents'...")
        
        # Verificar que existe en tabla documents
        try:
            table_response = supabase.table("documents").select("*").eq("case_id", TEST_CASE_ID).execute()
            
            if table_response.data:
                print(f"âœ… Registro encontrado en tabla 'documents':")
                for doc in table_response.data:
                    print(f"   ğŸ†” ID: {doc['id']}")
                    print(f"   ğŸ“› Nome: {doc['name']}")
                    print(f"   ğŸ·ï¸ Tag: {doc.get('document_tag', 'N/A')}")
                    print(f"   ğŸ“„ Tipo: {doc.get('document_type', 'N/A')}")
                    print(f"   ğŸ”— File URL: {doc.get('file_url', 'N/A')[:80]}...")
                    print(f"   ğŸ“Š Status: {doc.get('status', 'N/A')}")
                    print(f"   ğŸ“… Criado: {doc.get('created_at', 'N/A')}")
                    
                    # Verificar metadados
                    metadata = doc.get('metadata', {})
                    if metadata:
                        print(f"   ğŸ“‹ Metadados:")
                        print(f"      CNPJ: {metadata.get('cnpj', 'N/A')}")
                        print(f"      RazÃ£o Social: {metadata.get('razao_social', 'N/A')}")
                        print(f"      API Source: {metadata.get('api_source', 'N/A')}")
                        print(f"      Generated By: {metadata.get('generated_by', 'N/A')}")
            else:
                print(f"âŒ Registro NO encontrado en tabla 'documents'")
        except Exception as e:
            print(f"âŒ Error verificando tabla: {str(e)}")
        
        print(f"\nğŸ”— PASO 4: Verificando acceso a URL pÃºblica...")
        
        # Verificar acceso a URL pÃºblica
        if result.get("supabase_public_url"):
            try:
                import aiohttp
                async with aiohttp.ClientSession() as session:
                    async with session.head(result["supabase_public_url"]) as response:
                        if response.status == 200:
                            print(f"âœ… URL pÃºblica accesible:")
                            print(f"   ğŸ”— Status: {response.status}")
                            print(f"   ğŸ“„ Content-Type: {response.headers.get('content-type', 'N/A')}")
                            print(f"   ğŸ“Š Content-Length: {response.headers.get('content-length', 'N/A')}")
                        else:
                            print(f"âŒ URL pÃºblica no accesible: Status {response.status}")
            except Exception as e:
                print(f"âŒ Error verificando URL: {str(e)}")
        
        print(f"\nğŸ¯ RESUMEN FINAL:")
        print(f"   ğŸ“¦ Bucket 'documents': {'âœ… OK' if storage_info else 'âŒ FALLO'}")
        print(f"   ğŸ—„ï¸ Tabla 'documents': {'âœ… OK' if table_response.data else 'âŒ FALLO'}")
        print(f"   ğŸ”— URL pÃºblica: {'âœ… OK' if result.get('supabase_public_url') else 'âŒ FALLO'}")
        print(f"   ğŸ’¾ IntegraciÃ³n completa: {'âœ… EXITOSA' if all([storage_info, table_response.data, result.get('supabase_public_url')]) else 'âŒ PARCIAL'}")
        
    except Exception as e:
        print(f"âŒ Error inesperado: {str(e)}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(test_cartao_cnpj_completo())